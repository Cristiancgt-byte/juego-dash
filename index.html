<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Shooter - Responsive + Mobile Controls + Tienda</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --ui-bg: rgba(0,0,0,0.6);
      --accent: #48c6ef;
    }
    body {
      margin:0;
      font-family: Inter, system-ui, Arial, sans-serif;
      background:#071021;
      color:#eaf6ff;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      min-height:100vh;
      box-sizing:border-box;
      padding:12px;
    }
    h1{margin:6px 0 0 0;font-size:20px}
    #gameWrap{width:100%;max-width:760px;}
    canvas{
      width:100%;
      max-width:760px;
      height:auto;
      display:block;
      border-radius:10px;
      box-shadow:0 8px 30px rgba(2,6,23,0.7);
      background:#000;
    }
    #ui{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:6px;
    }
    button{
      background:linear-gradient(90deg,var(--accent),#7b61ff);
      color:#021018;
      border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;
    }
    #shopBtn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#9fb7c9}
    #shop{ display:none; background:var(--ui-bg); padding:14px; border-radius:12px; width:92%; max-width:680px; margin-top:10px; text-align:center; }
    #shop h2{margin:0 0 8px 0}
    .shop-grid{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
    .item{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;min-width:140px}
    #coinsDisplay{font-weight:800}
    /* Mobile controls - hidden on desktop */
    #mobile-controls { display:none; }
    @media (max-width:768px){
      #mobile-controls {
        display:flex;
        justify-content:space-between;
        align-items:center;
        position:fixed;
        bottom:8px;
        left:8px;
        right:8px;
        gap:12px;
        z-index:999;
        pointer-events:none;
      }
      .joystick{
        pointer-events:auto;
        display:flex;
        gap:10px;
        align-items:center;
        background: rgba(0,0,0,0.25);
        padding:8px;border-radius:12px;
      }
      .updown{display:flex;flex-direction:column;gap:8px}
      #mobile-controls button {
       font-size: 32px;   /* antes 24px */
       padding: 25px;     /* antes 15px */
       border-radius: 50%;
       border: none;
       background: rgba(255,255,255,0.25);
       color: white;
     }
      #btn-fire {
  font-size: 40px;   /* antes 28px */
  padding: 35px;     /* antes 20px */
  background: rgba(255,0,0,0.7);
}
    }
    /* HUD text */
    #hud{margin-top:6px;color:#cfeffb;font-size:14px}
  </style>
</head>
<body>
  <h1>Shooter: tienda & mobile controls</h1>

  <div id="gameWrap">
    <!-- Canvas internal resolution is 800x500 but scaled with CSS for responsiveness -->
    <canvas id="gameCanvas" width="800" height="500"></canvas>

    <div id="ui">
      <button id="startBtn">Comenzar</button>
      <button id="restartBtn" style="display:none">Reiniciar</button>
      <button id="shopBtn" style="display:none">Tienda ðŸ›’</button>
    </div>

    <div id="hud">
      <span id="scoreHUD">Puntos: 0</span> â€” 
      <span id="livesHUD">Vidas: 3</span> â€” 
      <span id="coinsHUD">Monedas: 0</span>
    </div>

    <!-- Tienda -->
    <div id="shop" aria-hidden="true">
      <h2>ðŸ›’ Tienda</h2>
      <p>Monedas: <span id="coinsDisplay">0</span></p>
      <div class="shop-grid">
        <div class="item"><div>Color jugador (50)</div><button onclick="buy('color')">Comprar</button></div>
        <div class="item"><div>+1 Vida (75)</div><button onclick="buy('vida')">Comprar</button></div>
        <div class="item"><div>Cambiar fondo (50)</div><button onclick="buy('fondo')">Comprar</button></div>
        <div class="item"><div>Cambiar color enemigos (50)</div><button onclick="buy('enemigo')">Comprar</button></div>
        <div class="item"><div>Mejorar rÃ¡faga (80)</div><button onclick="buy('rafaga')">Comprar</button></div>
        <div class="item"><div>Mejora x2 monedas (100)</div><button onclick="buy('dobleCoins')">Comprar</button></div>
      </div>
      <div style="margin-top:10px;">
        <button onclick="closeShop()" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfeffb">Cerrar</button>
      </div>
    </div>

    <!-- Mobile controls (only visible on small screens) -->
    <div id="mobile-controls" aria-hidden="true">
      <div class="joystick">
        <button id="btn-left">â—€</button>
        <div class="updown">
          <button id="btn-up">â–²</button>
          <button id="btn-down">â–¼</button>
        </div>
        <button id="btn-right">â–¶</button>
      </div>
      <button id="btn-fire">ðŸ”«</button>
    </div>
  </div>

<script>
/* ---------- Juego completo ---------- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Logical internal size (coordinates) - kept fixed for simplicity
const W = canvas.width;
const H = canvas.height;

// UI elems
const startBtn = document.getElementById('startBtn');
const restartBtn = document.getElementById('restartBtn');
const shopBtn = document.getElementById('shopBtn');
const shopDiv = document.getElementById('shop');
const coinsDisplay = document.getElementById('coinsDisplay');
const scoreHUD = document.getElementById('scoreHUD');
const livesHUD = document.getElementById('livesHUD');
const coinsHUD = document.getElementById('coinsHUD');

let game = null;
let rafId = null;

function resetGameState(){
  game = {
    running: false,
    player: {
      x: W/2, y: H-70, size: 28, speed: 5, lives: 3, shield:false, color:'lime'
    },
    bullets: [],
    enemies: [],
    pickups: [],
    score: 0,
    coins: 0,
    keys: {},
    tick: 0,
    lastShot: 0,
    fireDelay: 16,
    multip: 1,
    bgColor: '#001018',
    enemyColor: 'red',
    coinBoost: 1,
    rafagaLevel: 0, // extra projectiles
    running: false
  };
}

// Entities
class Bullet {
  constructor(x,y,dx=0,dy=-7,color='white'){
    this.x=x; this.y=y; this.dx=dx; this.dy=dy; this.r=5; this.color=color;
  }
  update(){ this.x+=this.dx; this.y+=this.dy; }
  draw(){
    ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.fillStyle=this.color; ctx.fill();
  }
}

class Enemy {
  constructor(x,y,type='square'){
    this.x=x; this.y=y; this.size=28; this.type=type;
    this.dy = 0.8 + Math.random()*1.6 + Math.random()*0.6;
    // slight horizontal movement for triangles
    this.dx = type==='triangle' ? (Math.random()*2-1.0) : 0;
  }
  update(){
    this.y += this.dy;
    this.x += this.dx;
    // wrap x
    if(this.x < 10) this.x = 10;
    if(this.x > W-10) this.x = W-10;
  }
  draw(){
    ctx.fillStyle = game.enemyColor;
    if(this.type==='square'){
      ctx.fillRect(this.x - this.size/2, this.y - this.size/2, this.size, this.size);
    } else {
      ctx.beginPath();
      ctx.moveTo(this.x, this.y - this.size/2);
      ctx.lineTo(this.x - this.size/2, this.y + this.size/2);
      ctx.lineTo(this.x + this.size/2, this.y + this.size/2);
      ctx.closePath();
      ctx.fill();
    }
  }
}

// Helpers
function rand(min,max){ return min + Math.random()*(max-min); }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

// Shoots according to rafagaLevel
function shoot(){
  const p = game.player;
  const baseX = p.x;
  const y = p.y - p.size/2 - 4;
  // single bullet
  game.bullets.push(new Bullet(baseX, y, 0, -9, '#fff'));
  // extra bullets if rafaga
  const r = game.rafagaLevel;
  for(let i=1;i<=r;i++){
    const spread = i * 8;
    game.bullets.push(new Bullet(baseX - spread, y, 0, -9, '#fff'));
    game.bullets.push(new Bullet(baseX + spread, y, 0, -9, '#fff'));
  }
}

// Spawn enemy mix
function spawnEnemy(){
  const type = Math.random() < 0.45 ? 'square' : 'triangle';
  const x = rand(40, W-40);
  game.enemies.push(new Enemy(x, -30, type));
}

// Update loop
function update(){
  if(!game.running) return;
  game.tick++;

  // movement via keys
  if(game.keys['ArrowLeft'] || game.keys['a']) game.player.x -= game.player.speed;
  if(game.keys['ArrowRight'] || game.keys['d']) game.player.x += game.player.speed;
  if(game.keys['ArrowUp'] || game.keys['w']) game.player.y -= game.player.speed;
  if(game.keys['ArrowDown'] || game.keys['s']) game.player.y += game.player.speed;

  // clamp player inside
  game.player.x = clamp(game.player.x, 20, W-20);
  game.player.y = clamp(game.player.y, 20, H-20);

  // shooting using e.code 'Space'
  if((game.keys['Space'] || game.keys[' ']) && (game.tick - game.lastShot > game.fireDelay)){
    shoot();
    game.lastShot = game.tick;
  }

  // spawn enemies progressively
  if(game.tick % Math.max(18, Math.floor(60 - game.score/40)) === 0){
    spawnEnemy();
  }

  // update bullets
  for(let b of game.bullets) b.update();
  game.bullets = game.bullets.filter(b => b.y > -30 && b.y < H+30);

  // update enemies
  for(let e of game.enemies) e.update();

  // collisions bullets vs enemies
  for(let i=game.enemies.length-1;i>=0;i--){
    const e = game.enemies[i];
    for(let j=game.bullets.length-1;j>=0;j--){
      const b = game.bullets[j];
      const dx = b.x - e.x, dy = b.y - e.y;
      if(Math.hypot(dx,dy) < (e.size/2 + b.r)){
        // hit
        game.enemies.splice(i,1);
        game.bullets.splice(j,1);
        game.score += 10 * game.multip;
        game.coins += (1 * game.coinBoost);
        break;
      }
    }
  }

  // enemies hitting player
  for(let i=game.enemies.length-1;i>=0;i--){
    const e = game.enemies[i];
    const dx = e.x - game.player.x, dy = e.y - game.player.y;
    if(Math.hypot(dx,dy) < (e.size/2 + game.player.size/2 - 2)){
      // collide
      game.enemies.splice(i,1);
      if(game.player.shield){
        game.player.shield = false;
      } else {
        game.player.lives--;
        if(game.player.lives <= 0){
          game.running = false;
          // show game over briefly
        }
      }
    }
  }

  // update HUD
  scoreHUD.textContent = `Puntos: ${game.score}`;
  livesHUD.textContent = `Vidas: ${game.player.lives}`;
  coinsHUD.textContent = `Monedas: ${game.coins}`;
  coinsDisplay.textContent = game.coins;
}

// Draw
function draw(){
  // clear background
  ctx.fillStyle = game.bgColor;
  ctx.fillRect(0,0,W,H);

  // draw player
  ctx.save();
  ctx.fillStyle = game.player.shield ? '#66f3ff' : game.player.color;
  ctx.translate(game.player.x, game.player.y);
  // draw as rounded rect
  ctx.beginPath();
  ctx.rect(-game.player.size/2, -game.player.size/2, game.player.size, game.player.size);
  ctx.fill();
  ctx.restore();

  // bullets
  for(let b of game.bullets) b.draw();

  // enemies
  for(let e of game.enemies) e.draw();

  // HUD texts (inside canvas)
  ctx.fillStyle = '#dff6ff';
  ctx.font = '16px sans-serif';
  ctx.fillText(`P: ${game.score}`, 12, 22);
  ctx.fillText(`V: ${game.player.lives}`, 12, 42);
  ctx.fillText(`C: ${game.coins}`, 12, 62);

  if(!game.running && game.player.lives <= 0){
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(0, H/2 - 50, W, 120);
    ctx.fillStyle = '#ff6b6b';
    ctx.font = '40px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('GAME OVER', W/2, H/2 + 10);
    ctx.textAlign = 'start';
  }
}

// Main loop
function loop(){
  update();
  draw();
  rafId = requestAnimationFrame(loop);
}

// Resize handling: canvas styled to be responsive via CSS width:100%;
// no need to change internal coords, but handle high-DPI for crispness
function adaptCanvasForHiDPI(){
  const ratio = window.devicePixelRatio || 1;
  canvas.width = W * ratio;
  canvas.height = H * ratio;
  canvas.style.width = Math.min(window.innerWidth - 24, 760) + 'px';
  canvas.style.height = (canvas.style.width.replace('px','') * (H / W)) + 'px';
  ctx.setTransform(ratio,0,0,ratio,0,0);
}
window.addEventListener('resize', adaptCanvasForHiDPI);
adaptCanvasForHiDPI();

/* ---------- Input (keyboard) ---------- */
window.addEventListener('keydown', (e)=>{
  if(!game) return;
  game.keys[e.key] = true;
  game.keys[e.code] = true;
  // toggle shop with T
  if(e.key === 't' || e.key === 'T') toggleShop();
});
window.addEventListener('keyup', (e)=>{
  if(!game) return;
  game.keys[e.key] = false;
  game.keys[e.code] = false;
});

/* ---------- Mobile Controls ---------- */
function setupMobileControls(){
  const btnLeft = document.getElementById('btn-left');
  const btnRight = document.getElementById('btn-right');
  const btnUp = document.getElementById('btn-up');
  const btnDown = document.getElementById('btn-down');
  const btnFire = document.getElementById('btn-fire');

  if(!btnLeft) return;

  const setKey = (k,v) => { if(game) game.keys[k] = v; };

  // helper to bind touch and mouse for better responsiveness
  const bind = (el, key) => {
    el.addEventListener('touchstart', (e)=>{ e.preventDefault(); setKey(key, true); }, {passive:false});
    el.addEventListener('touchend',   (e)=>{ e.preventDefault(); setKey(key, false); }, {passive:false});
    el.addEventListener('mousedown', ()=>setKey(key, true));
    el.addEventListener('mouseup',   ()=>setKey(key, false));
    el.addEventListener('mouseleave',()=>setKey(key, false));
  };

  bind(btnLeft, 'ArrowLeft');
  bind(btnRight, 'ArrowRight');
  bind(btnUp, 'ArrowUp');
  bind(btnDown, 'ArrowDown');
  bind(btnFire, 'Space');
}
setupMobileControls();

/* ---------- Shop features ---------- */
function toggleShop(){
  if(!shopDiv) return;
  shopDiv.style.display = (shopDiv.style.display === 'block') ? 'none' : 'block';
}
function closeShop(){ shopDiv.style.display = 'none'; }
function buy(item){
  if(!game) return;
  // costs and effects
  const costs = { color:50, vida:75, fondo:50, enemigo:50, rafaga:80, dobleCoins:100 };
  if(game.coins < costs[item]) { alert('No tienes suficientes monedas'); return; }
  game.coins -= costs[item];

  if(item === 'color'){
    const cols = ['lime','deepskyblue','orange','hotpink','white','gold'];
    game.player.color = cols[Math.floor(Math.random()*cols.length)];
  } else if(item === 'vida'){
    game.player.lives += 1;
  } else if(item === 'fondo'){
    const bg = ['#001018','#0b1020','#021018','#100018','#001100'];
    game.bgColor = bg[Math.floor(Math.random()*bg.length)];
  } else if(item === 'enemigo'){
    const cols = ['red','purple','yellow','green','cyan'];
    game.enemyColor = cols[Math.floor(Math.random()*cols.length)];
  } else if(item === 'rafaga'){
    game.rafagaLevel = (game.rafagaLevel || 0) + 1;
  } else if(item === 'dobleCoins'){
    game.coinBoost = 2;
  }
  // update displays
  coinsDisplay.textContent = game.coins;
  coinsHUD.textContent = `Monedas: ${game.coins}`;
}

/* ---------- Buttons ---------- */
startBtn.addEventListener('click', ()=>{
  resetGameState();
  game.running = true;
  // show shop button on start
  shopBtn.style.display = 'inline-block';
  restartBtn.style.display = 'inline-block';
  startBtn.style.display = 'none';
  shopDiv.style.display = 'none';
  // start loop
  if(!rafId) loop();
});
restartBtn.addEventListener('click', ()=>{
  // stop previous loop safely
  if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
  resetGameState();
  game.running = true;
  shopDiv.style.display = 'none';
  // ensure shop button visible
  shopBtn.style.display = 'inline-block';
  if(!rafId) loop();
});
shopBtn.addEventListener('click', ()=>{ toggleShop(); });

/* ---------- Init small things ---------- */
// start with initial state ready but not running
resetGameState();
// reflect initial HUD
coinsDisplay.textContent = game.coins;
scoreHUD.textContent = `Puntos: ${game.score}`;
livesHUD.textContent = `Vidas: ${game.player.lives}`;
coinsHUD.textContent = `Monedas: ${game.coins}`;

/* Make sure shop toggle with T works even before start */
window.addEventListener('keydown',(e)=>{
  if(e.key === 't' || e.key === 'T') {
    // only show if started
    if(document.getElementById('shopBtn').style.display !== 'none') toggleShop();
  }
});
</script>
</body>
</html>
